# 电解铝负荷虚拟储能降维模型实现说明

## 概述

本实现将原有的可调负荷（ALF）模型改为虚拟储能模型，以更好地捕捉电解铝负荷的状态变量时段耦合约束。将280个相互串联的电解槽视为一个虚拟储能系统，通过状态转移方程描述电解槽的能量状态变化。

## 数学模型

### 逆优化问题

```
min_Θ J = (1/N) * Σ(n=1 to N) ||p^(n) - p_n||²

s.t. p_n = arg min { Pr^(n)ᵀ * p_n : 
                     p_n ∈ [p_min, p_max]
                     e_{t+1} = θ * e_t + p_n * Δt + w * Δt
                     e_t ∈ [e_min, e_max] }
```

其中：
- `p_n`: 功率消耗向量
- `e_t`: 能量状态向量
- `θ`: 状态转移参数（自放电系数）
- `w`: 基础功率消耗
- `p_min, p_max`: 功率上下限
- `e_min, e_max`: 能量上下限

## 文件结构

### 1. 变量定义文件
- **文件名**: `add_varDef_and_initVal_virtual_battery.m`
- **功能**: 定义虚拟储能模型的所有变量和参数
- **主要变量**:
  - `p_max, p_min`: 功率约束参数
  - `e_max, e_min`: 能量约束参数
  - `theta`: 状态转移参数
  - `w`: 基础功率消耗
  - `p_t`: 功率变量
  - `e_t`: 能量状态变量

### 2. 逆优化文件
- **文件名**: `inverse_optimization_virtual_battery.m`
- **功能**: 实现虚拟储能模型的KKT条件和约束
- **主要约束**:
  - 平稳性条件（对功率和能量状态的梯度）
  - 功率约束：`p_t ∈ [p_min, p_max]`
  - 能量约束：`e_t ∈ [e_min, e_max]`
  - 状态转移约束：`e_{t+1} = θ * e_t + p_t * Δt + w * Δt`
  - 互补松弛条件

### 3. 训练脚本
- **文件名**: `model_training_eal.m`（已修改）
- **功能**: 执行虚拟储能模型的训练过程
- **主要特点**:
  - `NOFMODELS = 1`（固定为单个虚拟储能）
  - 使用随机梯度下降法更新参数
  - 自适应学习率调整

### 4. 测试脚本
- **文件名**: `test_virtual_battery_model.m`
- **功能**: 测试虚拟储能模型的各个组件

## 关键改进

### 1. 状态变量耦合
- 通过状态转移方程 `e_{t+1} = θ * e_t + p_t * Δt + w * Δt` 捕捉电解槽的能量状态变化
- 考虑了电解槽的自放电特性（θ参数）
- 包含了基础功率消耗（w参数）

### 2. 物理意义
- `θ`: 反映电解槽的自放电特性，通常在0.8-1.0之间
- `w`: 表示维持电解槽运行所需的基础功率
- `e_min, e_max`: 电解槽的能量状态范围
- `p_min, p_max`: 电解槽的功率调节范围

### 3. 约束处理
- 使用Fortuny-Amat变换处理互补松弛条件
- 添加了对偶变量约束避免数值问题
- 包含参数合理性约束

## 使用方法

### 1. 运行测试
```matlab
test_virtual_battery_model
```

### 2. 完整训练
```matlab
model_training_eal
```

### 3. 结果分析
训练结果保存在 `results/` 目录下，文件名格式为：
`data_eal_virtual_battery_[BATCH_SIZE]batch.mat`

## 参数说明

### 训练参数
- `TimeLimit = 120`: 每次迭代的最大求解时间（秒）
- `max_itr = 40`: 最大迭代次数
- `alpha = 0.05`: 初始学习率
- `BATCH_SIZE = 1:4`: 批次大小（天数）

### 模型参数
- `p_max_val`: 功率上限初始值
- `p_min_val`: 功率下限初始值
- `e_max_val`: 能量上限初始值
- `e_min_val`: 能量下限初始值
- `theta_val = 0.95`: 自放电系数初始值
- `w_val`: 基础功率消耗初始值

## 预期效果

1. **更好的物理建模**: 虚拟储能模型能够更好地反映电解槽的物理特性
2. **状态耦合捕捉**: 通过状态转移方程捕捉时段间的能量状态耦合
3. **参数可解释性**: 模型参数具有明确的物理意义
4. **计算效率**: 相比多ALF模型，单虚拟储能模型计算更高效

## 注意事项

1. 确保数据集文件路径正确
2. 需要安装Gurobi求解器和YALMIP工具箱
3. 训练过程可能需要较长时间，建议先用测试脚本验证
4. 参数初始化基于历史数据统计，可能需要根据实际情况调整
